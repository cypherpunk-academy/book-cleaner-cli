# Book Cleaner CLI - Implementation Plan (Updated)

## Overview

This document outlines the implementation plan for the Book Cleaner CLI project, a Node.js/TypeScript application that transforms raw book sources (PDFs, text files, EPUB) into clean, readable Markdown format with comprehensive metadata.

**Current Status (January 2025):** The project has advanced significantly beyond the original plan. Phase 1 and most core functionality is complete, with OCR processing fully operational. The focus now shifts to implementing the new step 1.2 approach with user review workflow, OCR caching, AI-powered text normalization, and Phase 2-4 implementations.

## Current Implementation Status ‚úÖ

### ‚úÖ COMPLETED PHASES

#### Phase 1: Project Foundation & Base Architecture - COMPLETE
- [x] **1.1 Project Setup** - TypeScript, Biome, Jest, CI/CD all configured
- [x] **1.2 Core Infrastructure** - Pino logging, ConfigService, CLI framework, error handling complete
- [x] **1.3 Pipeline Framework** - PipelineManager, AbstractPhase, step architecture complete

#### Phase 2: Text Extraction & Format Processing - COMPLETE
- [x] **2.1 File Format Detection & Validation** - Complete with security validation
- [x] **2.2 PDF Text Extraction** - Complete with hybrid text+OCR processing
- [x] **2.3 EPUB Text Extraction** - Complete with structure preservation
- [x] **2.4 Plain Text Processing** - Complete with encoding detection

#### Phase 3: OCR Integration & Text Comparison - COMPLETE
- [x] **3.1 OCR Service Integration** - Tesseract.js integrated with structured recognition
- [x] **3.2 Text Comparison Engine** - Complete quality assessment and comparison
- [x] **3.3 Smart Text Selection** - Intelligent text selection between sources

#### Phase 4: Basic Pipeline Implementation - COMPLETE
- [x] **4.1 Phase 1 Pipeline Implementation** - DataLoadingPhase fully functional
- [x] **4.2 Configuration System Integration** - BookStructureService with YAML configs
- [x] **4.3 CLI Interface Completion** - CleanBookCommand operational

### üîÑ UPDATED IMPLEMENTATIONS (Needs Implementation)

#### Phase 1: Step 1.2 - NEW APPROACH - OCR Structure Retrieval & User Review
- [ ] **1.2.1 Book Manifest Detection** - Check for existing book-manifest.yaml
- [ ] **1.2.2 OCR Structure Discovery** - Perform OCR when no manifest exists
- [ ] **1.2.3 Footnote Detection** - Detect footnotes from OCR results
- [ ] **1.2.4 User Review Workflow** - Exit with clear message for user review
- [ ] **1.2.5 Manifest Creation** - Generate initial book-manifest.yaml with discovered structure

#### Phase 2: Text Normalization & AI Cleaning - PLACEHOLDER
- [ ] **2.1 DeepSeek API Integration** - Text cleaning and normalization
- [ ] **2.2 Structured Text Processing** - Heading normalization, paragraph cleanup
- [ ] **2.3 German Text Optimization** - Umlaut handling, philosophical text processing

#### Phase 3: Evaluation & Analysis - PLACEHOLDER
- [ ] **3.1 Quality Metrics** - Comprehensive quality scoring
- [ ] **3.2 Analysis Reports** - Processing statistics and recommendations

#### Phase 4: AI Enhancements - PLACEHOLDER
- [ ] **4.1 Content Enhancement** - AI-powered improvements
- [ ] **4.2 Metadata Enrichment** - Enhanced book structure analysis

## üéØ IMMEDIATE PRIORITIES

### Priority 1: Step 1.2 User Review Workflow Implementation

**Duration:** 1-2 weeks
**Status:** CRITICAL - New approach requires implementation

The current step 1.2 needs to be updated to implement the new user review workflow where it exits after structure discovery for user review.

**Current Step 1.2 Behavior:**
- Always performs text extraction
- Prompts for boundaries if missing
- Continues through pipeline

**New Step 1.2 Behavior:**
- Check if book-manifest.yaml exists in book-artifacts
- If NO manifest: Perform OCR, detect structure, create manifest, EXIT for user review
- If manifest exists: Use existing structure, continue normally

**Required Implementation:**

#### 1.1 Book Manifest Detection System
**Deliverables:**
- [ ] Implement book-manifest.yaml existence check in TextExtractor
- [ ] Add manifest path resolution logic
- [ ] Create manifest validation and loading functions
- [ ] Integration with existing BookStructureService

**Key Components:**
```typescript
// New methods needed in TextExtractor:
async checkBookManifestExists(metadata: FilenameMetadata): Promise<boolean>
async loadExistingBookManifest(metadata: FilenameMetadata): Promise<BookManifest>
async createInitialBookManifest(metadata: FilenameMetadata, discoveredStructure: DiscoveredStructure): Promise<void>
async exitForUserReview(metadata: FilenameMetadata, discoveredStructure: DiscoveredStructure): Promise<never>
```

#### 1.2 OCR Structure Discovery
**Deliverables:**
- [ ] Enhanced OCR processing for structure discovery
- [ ] Footnote detection from OCR results using detectFootnotesFromOcr.ts
- [ ] Chapter and heading detection from OCR
- [ ] Structure metadata extraction and formatting

**Structure Discovery Process:**
```typescript
interface DiscoveredStructure {
    chapters: ChapterInfo[];
    footnotes: FootnoteInfo[];
    pageBoundaries: PageBoundaryInfo;
    textBoundaries: TextBoundaryInfo;
    metadata: BookMetadata;
}
```

#### 1.3 User Review Workflow
**Deliverables:**
- [ ] Clear exit message with instructions
- [ ] Generated book-manifest.yaml with discovered structure
- [ ] User-friendly guidance for manual review
- [ ] Validation of user-updated manifest on next run

**Exit Message Example:**
```
‚úÖ Structure Discovery Complete!

üìñ Book: Rudolf Steiner - Goethes Naturwissenschaftliche Schriften
üìÑ Discovered structure:
   - Chapters: 12 chapters detected
   - Footnotes: 45 footnotes found
   - Page boundaries: Pages 5-120 contain author content
   - Text boundaries: "m√ºsse, um ihm erkennend beizukommen." to "Daten zur Herausgabe"

üìù Next steps:
   1. Review the generated book-manifest.yaml file
   2. Update any incorrect structure information
   3. Re-run the command to continue processing

üìç Manifest location: book-artifacts/Rudolf_Steiner#Goethes_Naturwissenschaftliche_Schriften#GA_1/book-manifest.yaml
```

#### 1.4 Integration Points
- [ ] Update DataLoadingPhase to handle step 1.2 exit conditions
- [ ] Modify PipelineManager to support early exit with user review
- [ ] Update CLI to provide clear feedback about review process
- [ ] Add validation for user-updated manifests

### Priority 2: OCR Caching Implementation

**Duration:** 1-2 weeks
**Status:** HIGH PRIORITY - Currently OCR reprocesses every time

The book-artifacts structure exists but OCR caching is not implemented. This causes expensive OCR reprocessing on every run.

**Current Book-Artifacts Structure:**
```
book-artifacts/
‚îú‚îÄ‚îÄ default-book-manifest.yaml
‚îî‚îÄ‚îÄ <author>#<title>#<book-index>/
    ‚îú‚îÄ‚îÄ book-manifest.yaml (‚úÖ populated)
    ‚îú‚îÄ‚îÄ phase1/ (‚ùå empty - needs OCR cache)
    ‚îú‚îÄ‚îÄ phase2/ (empty)
    ‚îî‚îÄ‚îÄ phase3/ (empty)
```

**Required Implementation:**

#### 2.1 OCR Cache System
**Deliverables:**
- [ ] Implement OCR result caching in `phase1/` directory
- [ ] Cache structure: `phase1/ocr-cache.json` with metadata
- [ ] Cache validation based on file hash and processing parameters
- [ ] Cache expiration and invalidation logic
- [ ] Integration with existing OCRService.ts

**Key Components:**
```typescript
// New files needed:
src/services/CacheService.ts              // Generic caching service
src/services/OCRCacheService.ts           // OCR-specific caching
src/types/CacheTypes.ts                   // Cache interfaces
```

**Cache Structure in book-artifacts:**
```
<author>#<title>#<book-index>/phase1/
‚îú‚îÄ‚îÄ ocr-cache.json                 // OCR results and metadata
‚îú‚îÄ‚îÄ ocr-processing-info.json       // Processing parameters used
‚îú‚îÄ‚îÄ file-hash.txt                 // Original file hash for validation
‚îî‚îÄ‚îÄ pages/                        // Optional: individual page results
    ‚îú‚îÄ‚îÄ page-001.json
    ‚îú‚îÄ‚îÄ page-002.json
    ‚îî‚îÄ‚îÄ ...
```

#### 2.2 Integration Points
- [ ] Update `OCRService.performOCR()` to check cache first
- [ ] Update `TextExtractor` to use cached results when available
- [ ] Add cache invalidation when file changes detected
- [ ] Add CLI option to force cache refresh: `--no-cache`

#### 2.3 Cache Benefits
- **Performance:** Avoid expensive OCR reprocessing (300+ page books take 10+ minutes)
- **Consistency:** Same OCR results across runs
- **Development:** Faster iteration during development
- **Cost Efficiency:** Reduce computational costs

### Priority 3: Complete Phase 2 (Text Normalization)

**Duration:** 2-3 weeks
**Status:** HIGH PRIORITY

#### 3.1 DeepSeek API Integration
**Deliverables:**
- [ ] Implement DeepSeek API client with error handling
- [ ] Text cleaning prompts optimized for German philosophical texts
- [ ] Batch processing for large documents
- [ ] Rate limiting and retry logic
- [ ] **Exit on failure policy** (no fallbacks per user rules)

**Key Components:**
```typescript
src/services/DeepSeekService.ts           // API client
src/services/TextNormalizationService.ts  // Text processing orchestrator
src/templates/DeepSeekPrompts.ts          // Optimized prompts
```

#### 3.2 Structured Text Processing
**Deliverables:**
- [ ] Heading level normalization (H1, H2, H3)
- [ ] Paragraph structure optimization
- [ ] Footnote processing and formatting
- [ ] German umlaut and special character handling

#### 3.3 Integration with Existing Pipeline
- [ ] Replace TextNormalizationPhase placeholder
- [ ] Update PipelineManager to include real Phase 2
- [ ] Results saved to `results/` directory with intermediate outputs
- [ ] Integration with book-artifacts for caching normalized results

### Priority 4: Testing & Quality Assurance

**Duration:** 1-2 weeks
**Status:** MEDIUM PRIORITY

#### 4.1 Comprehensive Test Suite
**Current Status:** Basic test framework exists, needs comprehensive tests

**Deliverables:**
- [ ] Unit tests for step 1.2 user review workflow
- [ ] Unit tests for OCR caching system
- [ ] Integration tests for complete pipeline
- [ ] Test fixtures for various book formats
- [ ] Performance benchmarking tests
- [ ] Error handling tests

**Testing Structure:**
```
tests/
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ pipeline/step1-2-user-review.test.ts
‚îÇ   ‚îú‚îÄ‚îÄ services/CacheService.test.ts
‚îÇ   ‚îú‚îÄ‚îÄ services/OCRCacheService.test.ts
‚îÇ   ‚îî‚îÄ‚îÄ pipeline/DataLoadingPhase.test.ts
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îú‚îÄ‚îÄ pipeline/complete-pipeline.test.ts
‚îÇ   ‚îú‚îÄ‚îÄ user-review/user-review-workflow.test.ts
‚îÇ   ‚îî‚îÄ‚îÄ caching/ocr-cache-integration.test.ts
‚îú‚îÄ‚îÄ performance/
‚îÇ   ‚îî‚îÄ‚îÄ ocr-performance.test.ts
‚îî‚îÄ‚îÄ fixtures/
    ‚îú‚îÄ‚îÄ pdfs/sample-books/
    ‚îú‚îÄ‚îÄ book-manifests/
    ‚îî‚îÄ‚îÄ expected-outputs/
```

### Priority 5: Documentation Updates

**Duration:** 1 week
**Status:** LOW PRIORITY

**Deliverables:**
- [ ] Update README.md with user review workflow
- [ ] API documentation for new step 1.2 behavior
- [ ] Usage examples for user review process
- [ ] Developer setup guide updates

## üìã UPDATED PROJECT STRUCTURE

**Current Structure (Reflects Reality):**
```
src/
‚îú‚îÄ‚îÄ cli/
‚îÇ   ‚îî‚îÄ‚îÄ CleanBookCommand.ts              # ‚úÖ Complete CLI interface
‚îú‚îÄ‚îÄ constants.ts                         # ‚úÖ All constants centralized
‚îú‚îÄ‚îÄ handlers/                           # ‚úÖ Error and utility handlers
‚îú‚îÄ‚îÄ index.ts                            # ‚úÖ Main entry point
‚îú‚îÄ‚îÄ pipeline/
‚îÇ   ‚îú‚îÄ‚îÄ AbstractPhase.ts                # ‚úÖ Base phase class
‚îÇ   ‚îú‚îÄ‚îÄ PipelineManager.ts              # ‚úÖ Complete orchestrator
‚îÇ   ‚îú‚îÄ‚îÄ DataLoadingPhase.ts             # ‚úÖ Phase 1 implementation
‚îÇ   ‚îú‚îÄ‚îÄ TextNormalizationPhase.ts       # üîÑ Placeholder
‚îÇ   ‚îú‚îÄ‚îÄ EvaluationPhase.ts              # üîÑ Placeholder  
‚îÇ   ‚îú‚îÄ‚îÄ AIEnhancementsPhase.ts          # üîÑ Placeholder
‚îÇ   ‚îî‚îÄ‚îÄ phase_1_Text_Extraction_And_Format_Processing/
‚îÇ       ‚îú‚îÄ‚îÄ step_1_File_Format_Detection_And_Validation/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ FileFormatDetector.ts   # ‚úÖ Complete
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ExecutionSummary.ts     # ‚úÖ Complete
‚îÇ       ‚îú‚îÄ‚îÄ step_2_Text_Extraction/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ TextExtractor.ts        # üîÑ NEEDS UPDATE: User review workflow
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ detectFootnotesFromOcr.ts # ‚úÖ Complete footnote detection
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ExecutionSummary.ts     # ‚úÖ Complete
‚îÇ       ‚îú‚îÄ‚îÄ step_3_Text_Quality_Enhancement/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ TextComparator.ts       # ‚úÖ Complete
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ QualityValidator.ts     # ‚úÖ Complete
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ TextEnhancer.ts         # ‚úÖ Complete
‚îÇ       ‚îî‚îÄ‚îÄ step_4_Structure_Recognition/
‚îÇ           ‚îú‚îÄ‚îÄ ChapterRecognizer.ts    # üîÑ Partial
‚îÇ           ‚îî‚îÄ‚îÄ ExecutionSummary.ts     # üîÑ Basic
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ LoggerService.ts                # ‚úÖ Complete with tagged logging
‚îÇ   ‚îú‚îÄ‚îÄ ConfigService.ts                # ‚úÖ Complete YAML config loading
‚îÇ   ‚îú‚îÄ‚îÄ BookStructureService.ts         # ‚úÖ Complete book structure management
‚îÇ   ‚îú‚îÄ‚îÄ StructureAnalyzer.ts            # ‚úÖ Complete analysis service
‚îÇ   ‚îú‚îÄ‚îÄ CacheService.ts                 # ‚ùå NEEDS IMPLEMENTATION
‚îÇ   ‚îú‚îÄ‚îÄ OCRCacheService.ts              # ‚ùå NEEDS IMPLEMENTATION
‚îÇ   ‚îî‚îÄ‚îÄ DeepSeekService.ts              # ‚ùå NEEDS IMPLEMENTATION
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                        # ‚úÖ Complete type definitions
‚îÇ   ‚îú‚îÄ‚îÄ CacheTypes.ts                   # ‚ùå NEEDS IMPLEMENTATION
‚îÇ   ‚îî‚îÄ‚îÄ UserReviewTypes.ts              # ‚ùå NEEDS IMPLEMENTATION
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ FileUtils.ts                    # ‚úÖ Complete file operations
    ‚îú‚îÄ‚îÄ AppError.ts                     # ‚úÖ Complete error handling
    ‚îî‚îÄ‚îÄ ChalkUtils.ts                   # ‚úÖ Complete CLI formatting
```

**Book-Artifacts Structure (Current + Planned):**
```
book-artifacts/
‚îú‚îÄ‚îÄ default-book-manifest.yaml         # ‚úÖ Template
‚îî‚îÄ‚îÄ <author>#<title>#<book-index>/
    ‚îú‚îÄ‚îÄ book-manifest.yaml              # ‚úÖ Populated with metadata
    ‚îú‚îÄ‚îÄ phase1/                         # ‚ùå NEEDS OCR CACHE IMPLEMENTATION
    ‚îÇ   ‚îú‚îÄ‚îÄ ocr-cache.json             # üìã Planned: OCR results cache
    ‚îÇ   ‚îú‚îÄ‚îÄ ocr-processing-info.json   # üìã Planned: Processing parameters
    ‚îÇ   ‚îî‚îÄ‚îÄ file-hash.txt              # üìã Planned: File validation
    ‚îú‚îÄ‚îÄ phase2/                         # üìã Future: Normalized text cache
    ‚îî‚îÄ‚îÄ phase3/                         # üìã Future: Enhanced text cache
```

## üöÄ IMPLEMENTATION ROADMAP

### Sprint 1: Step 1.2 User Review Workflow (Weeks 1-2)
- [ ] Implement book manifest detection system
- [ ] Add OCR structure discovery functionality
- [ ] Create user review exit workflow
- [ ] Update TextExtractor with new behavior
- [ ] Testing and validation

### Sprint 2: OCR Caching (Weeks 3-4)
- [ ] Design and implement OCR caching system
- [ ] Integration with existing OCRService
- [ ] Testing and validation
- [ ] CLI cache management options

### Sprint 3: DeepSeek Integration (Weeks 5-6)  
- [ ] DeepSeek API client implementation
- [ ] Text normalization service
- [ ] German text optimization
- [ ] Phase 2 pipeline integration

### Sprint 4: Testing & Documentation (Weeks 7-8)
- [ ] Comprehensive test suite
- [ ] Performance benchmarking
- [ ] Documentation updates
- [ ] User acceptance testing

### Sprint 5: Phase 3-4 Implementation (Weeks 9-12)
- [ ] Evaluation phase implementation
- [ ] AI enhancements phase
- [ ] Final integration testing
- [ ] Production readiness

## üìä SUCCESS METRICS

### Immediate (Step 1.2 User Review):
- [ ] 100% successful structure discovery for new books
- [ ] Clear user guidance for manifest review
- [ ] Zero pipeline failures due to missing structure
- [ ] User satisfaction with review workflow

### Short-term (OCR Caching):
- [ ] OCR processing time reduced from 10+ minutes to <30 seconds on cache hit
- [ ] Cache hit rate >90% for repeated processing
- [ ] Zero false cache hits (perfect invalidation)

### Medium-term (Phase 2):
- [ ] DeepSeek integration working reliably
- [ ] Text normalization improving readability scores by >20%
- [ ] German text processing accuracy >95%

### Long-term (Complete Pipeline):
- [ ] End-to-end processing time <5 minutes for cached books
- [ ] Quality scores >85% for processed texts
- [ ] 100% pipeline success rate for supported formats

## üîß DEVELOPMENT GUIDELINES

### Step 1.2 User Review Requirements:
- **Manifest Detection:** Check book-artifacts for existing book-manifest.yaml
- **Structure Discovery:** OCR-based structure detection when no manifest exists
- **User Exit:** Clear exit message with instructions for manual review
- **Manifest Creation:** Generate initial manifest with discovered structure
- **Validation:** Validate user-updated manifest on subsequent runs

### OCR Caching Requirements:
- **Cache Invalidation:** File hash + processing parameters change
- **Cache Structure:** JSON format with metadata for easy inspection
- **Error Handling:** Graceful fallback to fresh OCR on cache corruption
- **CLI Integration:** `--no-cache` flag for forced reprocessing

### DeepSeek Integration Requirements:
- **Failure Policy:** Exit application on API failure (no fallbacks)
- **Rate Limiting:** Respect API limits with backoff
- **Prompt Optimization:** German philosophical text specific prompts
- **Batch Processing:** Handle large documents efficiently

### Code Quality Standards:
- **No `any` types:** Maintain strict TypeScript typing [[memory:3633241]]
- **Constants centralization:** All string constants in `constants.ts` [[memory:3633241]]
- **Intermediate results:** Always save to `results/` directory [[memory:3652284]]
- **Pipeline caching:** Use `book-artifacts/` for expensive operations

## üéØ NEXT ACTIONS

1. **Start Step 1.2 User Review Implementation** (This week)
   - Design book manifest detection system
   - Implement OCR structure discovery
   - Create user review exit workflow
   - Update TextExtractor with new behavior
   
2. **Plan OCR Caching Implementation** (Next sprint)
   - Design cache data structures
   - Implement CacheService and OCRCacheService
   - Update OCRService to check cache first
   
3. **Plan DeepSeek Integration** (Future sprint)
   - Research optimal prompts for German philosophical texts
   - Design API client with proper error handling
   - Plan text normalization algorithms

4. **Testing Strategy** (Ongoing)
   - Set up test fixtures with real book samples
   - Implement performance benchmarking
   - Create integration test suite

This updated plan reflects the new step 1.2 approach with user review workflow and provides a clear roadmap for implementing the crucial user interaction improvements and completing the remaining phases.
